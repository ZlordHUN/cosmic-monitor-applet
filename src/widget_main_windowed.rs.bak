// SPDX-License-Identifier: MPL-2.0

//! Widget implementation - regular window that shows/hides decorations based on movable flag

mod config;
mod i18n;
mod widget;

use config::Config;
use cosmic::cosmic_config::CosmicConfigEntry;

fn main() -> cosmic::iced::Result {
    // Get the system's preferred languages.
    let requested_languages = i18n_embed::DesktopLanguageRequester::requested_languages();

    // Enable localizations to be applied.
    i18n::init(&requested_languages);

    // Load configuration to check if we should be movable
    let config_handler = cosmic::cosmic_config::Config::new(
        "com.github.zoliviragh.CosmicMonitor",
        Config::VERSION,
    )
    .ok();
    
    let config = config_handler
        .as_ref()
        .and_then(|context| Config::get_entry(context).ok())
        .unwrap_or_default();

    // Configure settings based on movable state
    let settings = if config.widget_movable {
        // When movable (settings open), use a regular window with decorations
        cosmic::app::Settings::default()
            .size(cosmic::iced::Size::new(300.0, 200.0))
    } else {
        // When not movable, use borderless transparent window
        cosmic::app::Settings::default()
            .client_decorations(true)
            .resizable(Some(0.0))
            .transparent(true)
            .size(cosmic::iced::Size::new(300.0, 200.0))
    };

    // Starts the widget's event loop
    cosmic::app::run::<widget::MonitorWidget>(settings, ())
}
